services:
    traefik:
        container_name: traefik
        image: "traefik:latest"
        restart: unless-stopped
        networks:
            - traefik
        command:
            - --entrypoints.web.address=:80
            - --entrypoints.websecure.address=:443
            - --providers.docker
            - --log.level=ERROR
            # Let's Encrypt staging server
            # -> avoid rate limits during testing
            # -> remove this line for to use production server
            # -> delete `acme.json` when switching between staging and production
            - --certificatesresolvers.leresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
            - --certificatesresolvers.leresolver.acme.httpchallenge=true
            - --certificatesresolvers.leresolver.acme.email=${VPS_EMAIL}
            - --certificatesresolvers.leresolver.acme.storage=./acme.json
            - --certificatesresolvers.leresolver.acme.httpchallenge.entrypoint=web
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
            - "./acme.json:/acme.json"
        labels:
            - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"
            - "traefik.http.routers.http-catchall.entrypoints=web"
            - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
            - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

    portainer:
        container_name: portainer
        image: portainer/portainer-ce:lts
        restart: unless-stopped
        command: -H unix:///var/run/docker.sock
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - portainer_data:/data
        networks:
            - traefik
        labels:
            # Frontend
            - "traefik.enable=true"
            - "traefik.http.routers.frontend.rule=Host(`portainer.${VPS_DOMAIN}`)"
            - "traefik.http.routers.frontend.entrypoints=websecure"
            - "traefik.http.services.frontend.loadbalancer.server.port=9000"
            - "traefik.http.routers.frontend.service=frontend"
            - "traefik.http.routers.frontend.tls.certresolver=leresolver"

            # Edge
            - "traefik.http.routers.edge.rule=Host(`edge.${VPS_DOMAIN}`)"
            - "traefik.http.routers.edge.entrypoints=websecure"
            - "traefik.http.services.edge.loadbalancer.server.port=8000"
            - "traefik.http.routers.edge.service=edge"
            - "traefik.http.routers.edge.tls.certresolver=leresolver"

networks:
    traefik:
        driver: bridge
        name: traefik

volumes:
    portainer_data:
